#!/bin/bash

# Get the absolute path of the directory where this script lives
PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE}")" && pwd)"
CONTAINER_NAME="ruby-dev-container"
IMAGE_NAME="ruby-dev-env"

# Export IDs for Docker Compose
export USER_ID=$(id -u)
export GROUP_ID=$(id -g)

# 1. CHECK FOR UPDATES
# Get the creation timestamp of the local image (if it exists)
IMAGE_TIME=$(docker image inspect -f '{{.Created}}' "$IMAGE_NAME" 2>/dev/null)

if [ -n "$IMAGE_TIME" ]; then
	# Convert ISO 8601 timestamp to Unix epoch
	IMAGE_EPOCH=$(date -j -f "%Y-%m-%dT%H:%M:%S" "${IMAGE_TIME%.*}" "+%s" 2>/dev/null || date -d "$IMAGE_TIME" "+%s")

	# Check if Dockerfile or any file in configs/ is newer than the image
	# We use 'find' to get the max mtime of the build context
	LATEST_MOD=$(find "$PROJECT_DIR/Dockerfile" "$PROJECT_DIR/configs" -type f -exec stat -f "%m" {} + 2>/dev/null | sort -nr | head -n1)

	# Check for md5 (macOS) or md5sum (Linux)
	if command -v md5 >/dev/null 2>&1; then
		FILES_HASH=$(find "$PROJECT_DIR/Dockerfile" "$PROJECT_DIR/configs" -type f -exec md5 -q {} + | md5 -q)
	else
		FILES_HASH=$(find "$PROJECT_DIR/Dockerfile" "$PROJECT_DIR/configs" -type f -exec md5sum {} + | md5sum | cut -d' ' -f1)
	fi

	OLD_HASH=$(cat "$PROJECT_DIR/.build_hash" 2>/dev/null)

	if [ "$FILES_HASH" != "$OLD_HASH" ]; then
		echo "--- Changes detected. Rebuilding image... ---"
		docker compose -f "$PROJECT_DIR/docker-compose.yml" build && echo "$FILES_HASH" > "$PROJECT_DIR/.build_hash"
	fi

else
	echo "--- Image not found. Initial build... ---"
	docker compose -f "$PROJECT_DIR/docker-compose.yml" build
fi

# 2. Ensure the container is running in the background
if [ ! "$(docker ps -q -f name=$CONTAINER_NAME)" ]; then
	echo "--- Starting background dev environment ---"
	# -d runs it in the background
	docker compose -f "$PROJECT_DIR/docker-compose.yml" up -d --remove-orphans
fi

# 3. Always use 'exec' to enter the environment
# This calls your tmux-start.sh which handles create-or-attach
docker exec -it $CONTAINER_NAME tmux-start

